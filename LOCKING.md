# 檔案鎖定機制

本文檔說明 skill-blueprint 專案中的檔案鎖定機制，用於防止多個 Claude Code 會話同時操作藍圖導致的競爭條件（race condition）。

## 為什麼需要鎖定？

### 競爭條件風險場景

1. **同時建立藍圖**：
   - 兩個會話同時執行 `blueprint-feat`
   - 都檢測到 `current.md` 存在
   - 都嘗試暫停舊藍圖
   - 結果：可能導致檔案覆蓋或遺失

2. **同時暫停和廢棄**：
   - 會話 A 執行 `blueprint-suspend`
   - 會話 B 同時執行 `blueprint-abandon`
   - 結果：檔案可能被移動到錯誤的目錄

3. **恢復與建立衝突**：
   - 會話 A 執行 `blueprint-resume`
   - 會話 B 同時執行 `blueprint-feat`
   - 結果：`current.md` 可能被意外覆蓋

## 鎖定策略

### 鎖文件位置

使用專用的鎖文件：`.blueprint/.lock`

**為什麼不鎖定 `current.md`？**
- `current.md` 可能不存在（新專案、剛暫停/廢棄後）
- `current.md` 會被移動（暫停、廢棄、歸檔時）
- 專用鎖文件更穩定、語義更清楚

### 鎖定模式

所有藍圖操作都使用**排他鎖（exclusive lock）**：
- 同一時間只有一個會話可以操作藍圖
- 簡化實作，避免讀寫鎖的複雜性

### 逾時設定

- **等待時間**：5 秒
- **行為**：如果 5 秒內無法獲得鎖，操作失敗並顯示錯誤訊息
- **原因**：藍圖操作通常很快完成（< 1 秒），5 秒足夠避免短暫衝突

## 使用方式

### 基本語法

在 Bash 指令區塊開頭加入鎖定：

```bash
(
  # 嘗試獲得排他鎖，最多等待 5 秒
  flock -w 5 9 || { echo "❌ 無法獲得鎖定：另一個會話正在操作藍圖，請稍後再試"; exit 1; }

  # 實際的藍圖操作...
  # 例如：讀取、修改、移動檔案等

) 9>.blueprint/.lock
```

### 完整範例

```bash
# 確保 .blueprint 目錄存在
mkdir -p .blueprint || { echo "❌ 建立目錄失敗：請檢查檔案權限"; exit 1; }

# 在子 shell 中執行，並獲得鎖定
(
  # 獲得排他鎖
  flock -w 5 9 || { echo "❌ 無法獲得鎖定：另一個會話正在操作藍圖，請稍後再試"; exit 1; }

  # 檢查 current.md 是否存在
  if [ -f .blueprint/current.md ]; then
    echo "✓ 找到藍圖"
  else
    echo "❌ 找不到藍圖"
    exit 1
  fi

  # 更多操作...

) 9>.blueprint/.lock

echo "✓ 操作完成"
```

### 工作原理

1. `(...)` - 建立子 shell
2. `9>.blueprint/.lock` - 開啟檔案描述符 9，指向 `.blueprint/.lock`
3. `flock -w 5 9` - 在檔案描述符 9 上嘗試獲得排他鎖，最多等待 5 秒
4. 當子 shell 結束時，鎖自動釋放

## 需要鎖定的操作

### blueprint-feat.md
- **操作**：讀取/寫入/移動 `current.md`
- **原因**：可能暫停或歸檔舊藍圖，然後建立新藍圖

### blueprint-suspend.md
- **操作**：讀取/修改/移動 `current.md`
- **原因**：修改藍圖狀態，然後移動到 `suspended/`

### blueprint-resume.md
- **操作**：讀取/修改/移動 suspended 檔案和 `current.md`
- **原因**：可能暫停當前藍圖，然後恢復暫停的藍圖

### blueprint-abandon.md
- **操作**：讀取/修改/移動 `current.md`
- **原因**：修改藍圖狀態，然後移動到 `abandoned/`

### blueprint-ready.md
- **操作**：讀取 `current.md`（可能修改、歸檔、廢棄）
- **原因**：可能觸發歸檔或廢棄操作

### blueprint-clarify.md
- **操作**：只讀取 `current.md`
- **原因**：雖然只讀取，但加鎖可避免讀取到部分修改的檔案

## 錯誤處理

### 無法獲得鎖

```
❌ 無法獲得鎖定：另一個會話正在操作藍圖，請稍後再試
```

**原因**：
- 另一個 Claude Code 會話正在操作藍圖
- 鎖定時間超過 5 秒（罕見）

**解決方式**：
- 等待幾秒後重試
- 檢查是否有其他 Claude Code 會話正在執行藍圖操作

### 鎖文件權限問題

```
❌ 建立目錄失敗：請檢查檔案權限
```

**原因**：
- `.blueprint/` 目錄不存在且無法建立
- 檔案系統權限問題

**解決方式**：
- 檢查專案目錄的寫入權限
- 手動建立 `.blueprint/` 目錄：`mkdir -p .blueprint`

## 最佳實踐

### 1. 在所有藍圖操作開頭加鎖

確保在任何讀取或修改藍圖檔案的操作前獲得鎖。

### 2. 使用子 shell

使用 `(...)` 子 shell 確保鎖在操作完成後自動釋放。

### 3. 早期失敗

如果無法獲得鎖，立即失敗並顯示清楚的錯誤訊息，不要重試或等待過久。

### 4. 簡短的鎖定時間

藍圖操作應該盡量快速（< 1 秒），避免長時間持有鎖。

## 測試鎖定機制

### 手動測試

1. **開啟兩個終端**，進入同一專案目錄

2. **終端 1**：執行長時間操作（模擬）
   ```bash
   ( flock -w 5 9 || echo "failed"; sleep 10; echo "done" ) 9>.blueprint/.lock
   ```

3. **終端 2**：立即執行藍圖操作
   ```bash
   /blueprint-ready
   ```

4. **預期結果**：
   - 終端 2 應該在 5 秒內顯示「❌ 無法獲得鎖定」
   - 終端 1 的操作完成後，終端 2 才能成功執行

### 檢查鎖文件

```bash
# 檢查鎖文件是否存在
ls -la .blueprint/.lock

# 鎖文件應該存在，大小為 0（只是一個標記文件）
```

## 常見問題

### Q: 如果 Claude Code 會話崩潰，鎖會釋放嗎？

**A**: 會。`flock` 使用的是檔案描述符鎖，當程序終止時（包括崩潰），作業系統會自動釋放鎖。

### Q: 可以跨機器使用這個鎖嗎？

**A**: 不行。`flock` 是本機鎖，只能防止同一台機器上的競爭條件。如果在 NFS 或其他網路檔案系統上，需要使用其他鎖定機制（例如 `lockfile`）。

### Q: 為什麼選擇 5 秒逾時？

**A**: 藍圖操作通常很快（< 1 秒）。5 秒足以處理短暫的衝突，但不會讓使用者等待太久。如果經常遇到逾時，可能表示有其他問題（例如網路檔案系統延遲）。

### Q: 需要手動刪除 `.blueprint/.lock` 嗎？

**A**: 不需要。鎖文件會一直存在，但這不影響功能。鎖是基於檔案描述符的，不是基於檔案存在性。

## 維護注意事項

1. **所有修改藍圖的 Bash 指令都必須加鎖**
2. **使用統一的錯誤訊息格式**
3. **測試鎖定機制**：在實作新功能時，測試多會話情境
4. **文檔更新**：如果修改鎖定策略，更新此文檔
