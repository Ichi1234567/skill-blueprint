# 檔案鎖定機制

本文檔說明 skill-blueprint 專案中的檔案鎖定機制設計決策。標準實作見 `COMMON_PATTERNS.md`。

## 為什麼需要鎖定？

防止多個 Claude Code 會話同時操作藍圖導致的競爭條件（race condition）。

### 常見風險場景

- **同時建立藍圖**：兩個會話都檢測到 `current.md` 存在，都嘗試暫停舊藍圖 → 檔案可能覆蓋或遺失
- **同時暫停和廢棄**：一個會話暫停，另一個會話廢棄 → 檔案可能移動到錯誤的目錄
- **恢復與建立衝突**：一個會話恢復藍圖，另一個會話建立新藍圖 → `current.md` 可能被意外覆蓋

---

## 鎖定策略設計

### 1. 鎖文件位置

使用專用的鎖文件：`.blueprint/.lock`

**為什麼不鎖定 `current.md`？**
- `current.md` 可能不存在（新專案、剛暫停/廢棄後）
- `current.md` 會被移動（暫停、廢棄、歸檔時）
- 專用鎖文件更穩定、語義更清楚

### 2. 鎖定模式

所有藍圖操作都使用**排他鎖（exclusive lock）**：
- 同一時間只有一個會話可以操作藍圖
- 簡化實作，避免讀寫鎖的複雜性

### 3. 逾時設定

- **等待時間**：5 秒
- **行為**：無法獲得鎖時，操作失敗並顯示錯誤訊息
- **原因**：藍圖操作通常很快完成（< 1 秒），5 秒足夠避免短暫衝突

---

## 標準實作

詳見 `COMMON_PATTERNS.md` > 鎖定機制

基本語法：

```bash
mkdir -p .blueprint || { echo "❌ 建立目錄失敗：請檢查檔案權限"; exit 1; }

(
  flock -w 5 9 || { echo "❌ 無法獲得鎖定：另一個會話正在操作藍圖，請稍後再試"; exit 1; }

  # 實際的藍圖操作...

) 9>.blueprint/.lock
```

---

## 需要鎖定的操作

所有涉及讀取或修改藍圖檔案的指令：

- `blueprint-feat` - 可能暫停或歸檔舊藍圖
- `blueprint-suspend` - 修改並移動藍圖
- `blueprint-resume` - 可能暫停當前藍圖，恢復暫停的藍圖
- `blueprint-abandon` - 修改並移動藍圖
- `blueprint-ready` - 可能觸發歸檔或廢棄操作
- `blueprint-clarify` - 雖然只讀取，但加鎖避免讀取到部分修改的檔案

---

## 常見問題

### 如果 Claude Code 會話崩潰，鎖會釋放嗎？

會。`flock` 使用檔案描述符鎖，當程序終止時（包括崩潰），作業系統會自動釋放鎖。

### 可以跨機器使用這個鎖嗎？

不行。`flock` 是本機鎖，只能防止同一台機器上的競爭條件。

如果在 NFS 或其他網路檔案系統上，需要使用其他鎖定機制（例如 `lockfile`）。

### 為什麼選擇 5 秒逾時？

藍圖操作通常很快（< 1 秒）。5 秒足以處理短暫的衝突，但不會讓使用者等待太久。

### 需要手動刪除 `.blueprint/.lock` 嗎？

不需要。鎖文件會一直存在，但這不影響功能。鎖是基於檔案描述符的，不是基於檔案存在性。

---

## 平台支援

**macOS**: 支援（macOS 10.13+ 已內建 flock）
**Linux**: 支援（util-linux 套件）
**Windows**: 不支援（WSL 環境可用）

---

## 維護注意事項

1. **所有修改藍圖的 Bash 指令都必須加鎖**
2. **使用統一的錯誤訊息**（見 `COMMON_PATTERNS.md`）
3. **測試鎖定機制**：實作新功能時，測試多會話情境
4. **保持操作簡短**：藍圖操作應盡量快速（< 1 秒），避免長時間持有鎖
