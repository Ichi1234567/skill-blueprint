---
name: blueprint-suspend
description: 暫停當前進行中的藍圖，移到 suspended 目錄。當需要切換到其他藍圖或暫時不想繼續當前藍圖時使用。
---

# Blueprint Suspend - 暫停藍圖

將當前進行中的藍圖暫停，移到 `suspended/` 目錄，騰出空間給新的藍圖。

## 核心功能

- 暫停當前活躍的藍圖
- 記錄暫停時間和原因（可選）
- 移動到 suspended 目錄並保留所有資訊
- 更新關聯資訊（git branch、beads issues）

## 執行步驟

**重要：所有涉及檔案操作的 Bash 指令都必須在鎖定機制下執行**

在執行任何 Bash 指令前，使用以下格式獲得鎖定：

```bash
# 確保 .blueprint 目錄存在
mkdir -p .blueprint || { echo "❌ 建立目錄失敗：請檢查檔案權限"; exit 1; }

# 在鎖定下執行操作
(
  flock -w 5 9 || { echo "❌ 無法獲得鎖定：另一個會話正在操作藍圖，請稍後再試"; exit 1; }

  # 實際的藍圖操作...

) 9>.blueprint/.lock
```

---

1. **檢查當前藍圖**

   - 檢查 `.blueprint/current.md` 是否存在
   - 如果不存在：
     ```
     ❌ 沒有進行中的藍圖可以暫停

     目前沒有活躍的藍圖。
     ```

2. **確認暫停意圖**

   - 讀取藍圖資訊（功能名稱、類型、狀態）
   - 如果使用者只是執行 `/blueprint-suspend` 沒有說明：
     ```
     確定要暫停當前藍圖嗎？

     藍圖：[功能名稱]
     類型：[類型]
     狀態：[當前狀態]

     暫停後可以隨時使用 /blueprint-resume 恢復。
     ```

3. **讀取暫停原因**

   - 如果使用者在訊息中已經說明原因（例如：「暫停這個，我要先處理其他功能」），直接使用
   - 如果沒有提到，不詢問，原因留空

4. **更新關聯資訊（如果需要）**

   - 檢查藍圖的「關聯資訊」區塊
   - 如果 Git Branch 或 Beads Issues 是空的：
     ```
     在暫停前，要更新關聯資訊嗎？（建議，方便恢復時知道要切到哪個 branch）

     目前記錄：
     - Git Branch: [空白或目前的值]
     - Beads Issues: [空白或目前的值]

     選項：
     A. 更新資訊
     B. 跳過
     ```
   - 如果選擇更新：
     - 問：「Git branch 名稱是？（可選）」
     - 問：「相關的 beads issue IDs？（用逗號分隔，例如：beads-123, beads-124）」（可選）
   - 使用 Edit 工具更新藍圖的「關聯資訊」區塊

5. **讀取藍圖資訊**

   - 從藍圖檔案讀取：功能名稱、建立時間、類型
   - 當前日期作為暫停日期

6. **更新藍圖狀態**

   - 使用 Edit 工具在藍圖的「狀態」後面加上：
     ```markdown
     **暫停時間**: 2025-12-24
     **暫停原因**: [原因或留空]
     ```
   - 有原因的格式：
     ```markdown
     **狀態**: In Progress
     **暫停時間**: 2025-12-24
     **暫停原因**: 要先處理其他功能
     ```
   - 沒有原因的格式（保留空欄位）：
     ```markdown
     **狀態**: In Progress
     **暫停時間**: 2025-12-24
     **暫停原因**:
     ```

7. **生成暫停檔名**

   - 格式：`{暫停日期}-{類型}-{slug}.md`
   - slug 生成規則（**含安全檢查**）：
     - 從功能名稱轉換
     - **安全性**：移除路徑分隔符（`/`、`\`）和路徑遍歷（`..`）
     - 轉小寫（中文保留、英文轉小寫）
     - 空格和特殊字元改為 `-`
     - 移除連續的 `-`
     - 移除開頭和結尾的 `-`
     - **限制長度為 30 字元**（保持檔名簡潔可辨識）
   - 範例：
     - "使用者認證系統" → "使用者認證系統"
     - "User Auth System" → "user-auth-system"

8. **執行暫停**

   - 使用 Bash 在鎖定下執行暫停操作：
     ```bash
     # 確保目錄存在
     mkdir -p .blueprint/suspended .blueprint || { echo "❌ 建立目錄失敗：請檢查檔案權限"; exit 1; }

     # 在鎖定下移動檔案
     (
       flock -w 5 9 || { echo "❌ 無法獲得鎖定：另一個會話正在操作藍圖，請稍後再試"; exit 1; }

       # 移動檔案到暫停目錄
       mv .blueprint/current.md .blueprint/suspended/{檔名} || { echo "❌ 暫停失敗：無法移動檔案"; exit 1; }

     ) 9>.blueprint/.lock
     ```
   - 回報：
     ```
     ✓ 藍圖已暫停

     檔案：.blueprint/suspended/{檔名}
     類型：{類型}
     功能：{功能名稱}
     暫停原因：{原因}（如果有）

     關聯資訊：
     - Git Branch: {branch}（如果有）
     - Beads Issues: {issues}（如果有）

     現在可以開始新的藍圖，或使用 /blueprint-resume 恢復暫停的藍圖。
     ```

## 範例

使用者說「暫停這個藍圖，我要先處理其他功能」：

```
確定要暫停「使用者認證系統」藍圖嗎？

讀取藍圖資訊...
更新關聯資訊...
- Git Branch: feature/user-auth
- Beads Issues: beads-123

生成檔名：2025-12-24-feat-使用者認證系統.md

✓ 藍圖已暫停

檔案：.blueprint/suspended/2025-12-24-feat-使用者認證系統.md
類型：功能開發 (feat)
功能：使用者認證系統
暫停原因：要先處理其他功能

關聯資訊：
- Git Branch: feature/user-auth
- Beads Issues: beads-123

現在可以開始新的藍圖，或使用 /blueprint-resume 恢復暫停的藍圖。
```

## 暫停後的藍圖格式

```markdown
# Blueprint: 使用者認證系統

**建立時間**: 2025-12-20
**類型**: feat
**狀態**: In Progress
**暫停時間**: 2025-12-24
**暫停原因**: 要先處理其他功能

**關聯資訊**:
- Git Branch: feature/user-auth
- Beads Issues: beads-123

## 功能描述
...

## 階段規劃
[原本的規劃保持不變，包含階段狀態]
```

## 注意事項

- 暫停不會改變藍圖的「狀態」欄位（保持 Draft/In Progress）
- 只是加上「暫停時間」和「暫停原因」標記
- 所有階段進度都會保留
- 暫停時建議更新關聯資訊，方便恢復時知道要切到哪個 branch
- 檔名中的日期是「暫停日期」而非「建立日期」
