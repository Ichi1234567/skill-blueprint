---
name: blueprint-ready
description: 檢查藍圖狀態，顯示進度，建議下一步該執行哪個階段。當想知道目前進度、或不確定下一步該做什麼時使用。
---

# Blueprint Ready - 檢查狀態

分析目前的藍圖進度，判斷哪些階段已完成、哪個階段該進行，並提供明確的下一步建議。

## 執行步驟

1. **載入藍圖**

   **1.0 自動遷移舊格式（向下相容）**

   - 首先檢查 `.blueprint/current.md` 是否存在
   - 如果存在：
     - 偵測到舊格式，自動遷移為 `current-feat.md`
     - 使用 Read 工具讀取內容
     - 使用 Write 工具寫入 `current-feat.md`
     - 使用 Bash 重新命名：`mv .blueprint/current.md .blueprint/current.md.old`
     - 在輸出中提示：「✓ 已自動遷移舊藍圖為新格式」

   **1.1 讀取藍圖檔案**

   - 嘗試讀取藍圖檔案（依照優先順序）：
     1. `.blueprint/current-feat.md`（功能開發）
     2. `.blueprint/current-idea.md`（想法探索）
     3. `.blueprint/current-debug.md`（問題修復）
   - 如果都不存在：
     ```
     ❌ 找不到進行中的藍圖

     請先建立藍圖：
     - /blueprint-feat "功能描述" - 建立功能開發藍圖

     範例：
     /blueprint-feat "實作使用者登入功能"
     ```
   - 記錄當前藍圖類型（feat/idea/debug）和檔案路徑供後續步驟使用

2. **解析階段狀態**

   從每個階段的「狀態」欄位讀取：
   - `Pending` - 尚未開始
   - `In Progress` - 進行中
   - `Done` - 已完成
   - `Blocked` - 被阻塞（依賴未滿足）

   計算統計：
   - 總階段數
   - 已完成數
   - 進行中數
   - 待執行數

3. **檢查依賴關係**

   對於每個 `Pending` 階段：
   - 解析「依賴」欄位
   - 如果是「無」→ 可立即執行（無依賴）
   - 如果是「階段 N」→ 檢查階段 N 的狀態：
     - 如果階段 N 是 `Done` → 依賴已滿足，可執行
     - 如果階段 N 不是 `Done` → 標記為 `Blocked`
   - 識別**可立即執行**的階段

4. **階段複雜度分析**

   針對下一個可執行的階段，分析其複雜度：

   **簡單階段**（符合以下所有條件）：
   - 預期產出 ≤ 3 個項目
   - 目標描述簡短明確（< 50 字）
   - 沒有 ⚠️ 複雜度標記

   **複雜階段**（符合任一條件）：
   - 預期產出 > 5 個項目
   - 目標描述包含多個「和」、「以及」（> 3 個）
   - 已有 ⚠️ 複雜度標記

   **中等階段**：
   - 不符合簡單或複雜的標準

5. **判斷下一步**

   根據不同情況提供建議：

   **情況 A：所有階段完成**
   ```
   🎉 藍圖已全部完成！

   完成的階段：
   ✓ 階段 1: [名稱]
   ✓ 階段 2: [名稱]
   ✓ 階段 3: [名稱]

   **接下來要歸檔這個藍圖嗎？**

   我可以幫你：
   1. 更新藍圖狀態為 "Completed"
   2. 生成歸檔檔名並移動到 archive/
      格式：{建立日期}-{類型}-{slug}.md
      例如：2025-12-24-feat-user-auth.md

   回覆「歸檔」或「完成歸檔」，我會自動處理。

   或者：
   - 自己手動更新狀態為 "Completed"
   - 執行 /blueprint-feat 開始新藍圖時會提示歸檔
   ```

   **情況 B：有進行中的階段**
   ```
   → 階段 [N] 進行中：[名稱]

   **目標**：[階段目標]

   **預期產出**：
   - [產出1]
   - [產出2]

   建議：
   繼續完成此階段，完成後請記得更新狀態！

   👉 完成時請執行：
   1. 編輯 .blueprint/current.md
   2. 將階段 [N] 的「狀態: In Progress」改為「狀態: Done」
   3. 在「檢查記錄」區段加上記錄：
      ### [YYYY-MM-DD HH:MM]
      - 階段 [N] 完成：[簡述完成的內容]
   ```

   **情況 C：有可執行的下一階段**

   根據步驟 4 分析的複雜度，提供不同建議：

   **C1. 簡單階段**
   ```
   建議開始：階段 [N] - [名稱]

   **目標**：[階段目標]
   **複雜度**：簡單 ✓
   **依賴**：[顯示依賴資訊]

   **預期產出**（[數量] 個）：
   - [產出1]
   - [產出2]

   **準備開始了嗎？**

   如果你要開始這個階段，回覆：
   - "開始階段 [N]" 或 "我要開始了" → 我會幫你更新狀態為 In Progress
   - 或自己手動編輯 .blueprint/current.md

   **建議行動**（直接建立任務）：

   此階段目標明確且簡單，建議直接建立 beads 任務開始執行。

   ◆ 選項 1：自行建立任務

   [如果依賴 = 無]
   bd create --title="階段[N]：[名稱]" --type=task --priority=2 \
     --description="目標：[階段目標]

   產出：
   - [產出1]
   - [產出2]

   可行性：[可行性說明]"

   [如果依賴 = 階段 M]
   # 先建立任務
   bd create --title="階段[N]：[名稱]" --type=task --priority=2 \
     --description="目標：[階段目標]

   產出：
   - [產出1]
   - [產出2]

   可行性：[可行性說明]"

   # 再建立依賴（假設階段 M 的 beads ID 是 beads-00M）
   bd dep add beads-00[N] beads-00[M]

   💡 提示：執行 `bd list` 查看階段 M 的實際 beads ID

   ◆ 選項 2：請我協助建立
   回覆「幫我建立階段 [N] 的任務」，我會自動執行 bd create 和 dep add 指令

   👉 完成後記得：
   1. 編輯 .blueprint/current.md，將階段 [N] 的「狀態: In Progress」改為「狀態: Done」
   2. 在「檢查記錄」區段加上完成記錄（含時間戳記）
   3. 執行 /blueprint-ready 查看下一步
   ```

   **C2. 中等階段**
   ```
   建議開始：階段 [N] - [名稱]

   **目標**：[階段目標]
   **複雜度**：中等
   **依賴**：[顯示依賴資訊]

   **預期產出**（[數量] 個）：
   - [產出1]
   - [產出2]
   - [產出3]

   **準備開始了嗎？**

   如果你要開始這個階段，回覆：
   - "開始階段 [N]" 或 "我要開始了" → 我會幫你更新狀態為 In Progress
   - 或自己手動編輯 .blueprint/current.md

   **建議行動**（兩種選擇）：

   ◆ 選項 1：直接建立 beads 任務（如果你清楚怎麼做）
   自行執行：
   bd create --title="階段[N]：[名稱]" --type=task --priority=2
   [如果有依賴]
   bd dep add beads-00[N] beads-00[M]  # 建立與階段 M 的依賴

   或請我協助：
   回覆「幫我建立階段 [N] 的任務」

   ◆ 選項 2：先用 speckit 細化（如果需要更詳細規劃）
   自行執行：
   /speckit.specify "階段[N]：[階段目標的詳細描述]"

   或請我協助：
   回覆「幫我為階段 [N] 建立 spec」

   選擇依據：
   - 技術路徑清楚 → 選 1（節省時間）
   - 有不確定的地方 → 選 2（降低風險）
   ```

   **C3. 複雜階段**
   ```
   建議開始：階段 [N] - [名稱]

   **目標**：[階段目標]
   **複雜度**：高 ⚠️

   **預期產出**（[數量] 個）：
   - [產出1]
   - [產出2]
   - [產出3]
   - [產出4]
   - [產出5]
   [...]

   [如果有複雜度標記]
   ⚠️ 此階段包含多個子任務，建議先細化規劃

   **準備開始了嗎？**

   如果你要開始這個階段，回覆：
   - "開始階段 [N]" 或 "我要開始了" → 我會幫你更新狀態為 In Progress
   - 或自己手動編輯 .blueprint/current.md

   **建議行動**（強烈建議使用 speckit）：

   ◆ 選項 1：使用 speckit 建立詳細規格（強烈推薦）
   自行執行：
   /speckit.specify "階段[N]：[階段目標的完整描述，包含所有預期產出]"

   或請我協助：
   回覆「幫我為階段 [N] 建立詳細規格」

   這會幫助你：
   - 釐清需求細節
   - 識別潛在問題
   - 建立完整的測試計畫
   - 拆解成更小的 tasks

   ◆ 選項 2：建立子藍圖（如果階段過於龐大）
   /blueprint-feat "階段[N] 詳細規劃：[階段目標]"

   將此階段再拆成更小的子階段

   ⚠️ 不建議直接實作：複雜階段未經細化容易遺漏重要細節
   ```

   **情況 D：下一階段被阻塞**
   ```
   ⚠️ 階段 [N] 被阻塞

   **原因**：
   ✗ 必要需求：階段 [M] - 未完成（目前狀態：Pending）

   **建議**：
   先完成階段 [M]，或手動調整階段順序

   要查看階段 [M] 的詳情嗎？
   執行 /blueprint-ready 會顯示目前可執行的階段
   ```

5. **顯示整體進度**

   計算並顯示進度：

   ```
   進度: ███░░ 3/5 (60%)
   ```

   階段清單（使用圖示）：
   ```
   ✓ 階段 1: 資料結構設計 - Done
   ✓ 階段 2: API 規劃 - Done
   → 階段 3: 核心邏輯實作 - Pending (建議下一步)
     階段 4: 測試撰寫 - Blocked (等待階段3)
     階段 5: 文件整理 - Pending (等待階段4)
   ```

   圖示說明：
   - `✓` = 已完成 (Done)
   - `→` = 建議下一步（可執行的 Pending）
   - `⚠️` = 被阻塞 (Blocked)
   - `🔄` = 進行中 (In Progress)
   - `[空白]` = 待執行但不是下一步

6. **完整報告格式**

   ```markdown
   ## Blueprint 狀態報告

   **藍圖**：[功能名稱]
   **建立時間**：[YYYY-MM-DD]
   **進度**：███░░ 3/5 (60%)

   ### 階段清單

   ✓ 階段 1: [名稱] - Done
   ✓ 階段 2: [名稱] - Done
   → 階段 3: [名稱] - Pending (建議下一步)
     階段 4: [名稱] - Blocked (等待階段3)
     階段 5: [名稱] - Pending (等待階段4)

   ---

   ### 建議行動

   [根據情況 A/B/C/D 的詳細建議]

   ---

   [如果有複雜度標記的階段]
   ### ⚠️ 複雜階段提醒

   以下階段被標記為複雜，執行時建議細化：
   - 階段 3: [名稱] - [複雜原因]
   ```

## AI 主動協助歸檔藍圖

當使用者回覆「歸檔」、「完成歸檔」或類似訊息時：

### 執行步驟

1. **讀取藍圖資訊**
   - 從藍圖檔案讀取：功能名稱、建立時間、藍圖類型（從檔名判斷）
   - 檢查藍圖狀態是否為 "Completed"

2. **更新狀態（如果尚未完成）**
   - 如果狀態不是 "Completed"，使用 Edit 工具更新為 "Completed"
   - 在「檢查記錄」區段加上完成記錄

3. **生成歸檔檔名**
   - 格式：`{建立日期}-{類型}-{slug}.md`
   - slug 生成規則：
     - 從功能名稱轉換
     - 轉小寫（中文保留、英文轉小寫）
     - 空格和特殊字元改為 `-`
     - 移除連續的 `-`
     - 範例：
       - "使用者認證系統" → "使用者認證系統"
       - "User Authentication System" → "user-authentication-system"
       - "API 重構 v2" → "api-重構-v2"

4. **執行歸檔**
   - 確保 `.blueprint/archive/` 目錄存在（使用 Bash: `mkdir -p .blueprint/archive`）
   - 使用 Bash 移動檔案：`mv .blueprint/current-{type}.md .blueprint/archive/{檔名}`
   - 回報：
     ```
     ✓ 藍圖已歸檔

     檔案：.blueprint/archive/{檔名}
     類型：{類型}
     功能：{功能名稱}

     現在可以開始新的藍圖了！
     ```

### 範例

使用者說「歸檔」時：
```
讀取藍圖：使用者認證系統（建立於 2025-12-24）
生成檔名：2025-12-24-feat-使用者認證系統.md

✓ 藍圖已歸檔

檔案：.blueprint/archive/2025-12-24-feat-使用者認證系統.md
類型：功能開發 (feat)
功能：使用者認證系統

現在可以開始新的藍圖了！
```

## AI 主動協助更新狀態（混合模式）

在對話過程中，AI 應該主動偵測以下時機並協助更新藍圖狀態：

### 時機 1：使用者明確表示要開始階段

**偵測訊號**：
- "開始階段 N"
- "我要做階段 N 了"
- "幫我建立階段 N 的任務"
- "開始實作階段 N"

**AI 行動**：
1. 詢問確認：「要我幫你更新 `.blueprint/current.md`，將階段 N 的狀態改為 In Progress 嗎？」
2. 得到確認後：
   - 使用 Edit 工具更新階段狀態：`Pending` → `In Progress`
   - 在「檢查記錄」區段加上時間戳記和記錄
3. 回報：「已更新階段 N 為 In Progress」

### 時機 2：使用者表示階段完成

**偵測訊號**：
- "完成了"、"做完了"、"搞定了"（在討論某個階段的情境中）
- "階段 N 完成了"
- 剛完成該階段的最後一個預期產出

**AI 行動**：
1. 主動建議：「看起來階段 N 已經完成了！要我幫你更新狀態為 Done，並記錄完成時間嗎？」
2. 詢問完成內容：「可以簡單描述一下完成了什麼嗎？（會記錄在檢查記錄中）」
3. 得到確認和描述後：
   - 使用 Edit 工具更新階段狀態：`In Progress` → `Done`
   - 在「檢查記錄」區段加上時間戳記和完成描述
4. 回報：「已更新階段 N 為 Done，並記錄完成內容」

### 時機 3：使用者明確指示更新

**偵測訊號**：
- "更新階段 N 為 [狀態]"
- "把階段 N 標記為完成"
- "將階段 N 改成進行中"

**AI 行動**：
直接執行（不需詢問）：
1. 使用 Edit 工具更新階段狀態
2. 在「檢查記錄」區段加上時間戳記和記錄
3. 回報：「已更新階段 N 為 [狀態]」

### 更新格式範例

**開始階段時**：
```markdown
## 檢查記錄

### [2025-12-24 15:30]

- 階段 2 狀態變更：Pending → In Progress
```

**完成階段時**：
```markdown
### [2025-12-24 17:45]

- 階段 2 完成：已完成 API 端點設計，包含認證、使用者管理等 5 個端點
- 狀態變更：In Progress → Done
```

## 注意事項

- **混合模式**：
  - 開始階段：詢問確認後更新（避免誤判）
  - 完成階段：主動建議並詢問完成內容
  - 明確指示：直接更新
- **清楚標示**：用圖示清楚標示狀態
- **具體建議**：提供可直接執行的指令範例
- **複雜度提醒**：如果下一階段有複雜標記，特別提醒
- **記錄異動**：所有狀態變更都必須記錄在「檢查記錄」區段，包含時間戳記

## 如何更新階段狀態

手動編輯 `.blueprint/current.md`：

**步驟 1：更新階段狀態**
```markdown
### 階段 2: API 規劃

- **狀態**: Pending  ← 改這裡

改為：

- **狀態**: In Progress  ← 開始工作時
- **狀態**: Done          ← 完成時
```

**步驟 2：記錄在檢查記錄區段**
```markdown
## 檢查記錄

### [2025-12-24 15:30]

- 階段 2 狀態變更：Pending → In Progress

### [2025-12-24 17:45]

- 階段 2 完成：已完成 API 端點設計，包含認證、使用者管理等 5 個端點
```
